{% extends 'base.html' %}
{% load static %}
{% block title %}{% if form.instance.pk %}Modifier{% else %}Créer{% endif %} un Cours - MyKarfour{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-5xl mx-auto">
        <div class="bg-white rounded-lg shadow-md p-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">
                {% if form.instance.pk %}Modifier le cours{% else %}Créer un nouveau cours{% endif %}
            </h1>

            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <div class="space-y-6">
                    <!-- Titre -->
                    <div>
                        <label for="{{ form.titre.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Titre du cours *
                        </label>
                        {{ form.titre }}
                        {% if form.titre.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.titre.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Matière et Niveau -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Matière -->
                        <div>
                            <label for="{{ form.matiere.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Matière *
                            </label>
                            {{ form.matiere }}
                            {% if form.matiere.errors %}
                            <p class="text-red-500 text-sm mt-1">{{ form.matiere.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Niveau -->
                        <div>
                            <label for="{{ form.niveau.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Niveau scolaire
                            </label>
                            {{ form.niveau }}
                            {% if form.niveau.errors %}
                            <p class="text-red-500 text-sm mt-1">{{ form.niveau.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Contenu avec préservation du format -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label for="contenu" class="block text-sm font-medium text-gray-700">
                                Contenu du cours *
                            </label>
                            <div class="text-xs text-gray-500">
                                <i class="fas fa-info-circle mr-1"></i>
                                Format préservé (sauts de ligne et espaces)
                            </div>
                        </div>
                        
                        <!-- Barre d'outils de formatage pour formulaires -->
                        <div class="mb-3 p-3 bg-gray-50 border border-gray-200 rounded-md">
                            <div class="flex flex-wrap gap-2 mb-2">
                                <span class="text-sm font-medium text-gray-700 mr-3">Formatage :</span>
                                <button type="button" class="format-tool" data-insert="───────────────">
                                    <i class="fas fa-minus"></i> Ligne
                                </button>
                                <button type="button" class="format-tool" data-insert="_______________">
                                    <i class="fas fa-underline"></i> Champ
                                </button>
                                <button type="button" class="format-tool" data-insert="•">
                                    <i class="fas fa-circle"></i> Point
                                </button>
                                <button type="button" class="format-tool" data-insert="→">
                                    <i class="fas fa-arrow-right"></i> Flèche
                                </button>
                                <button type="button" class="format-tool" data-insert="☐">
                                    <i class="far fa-square"></i> Case
                                </button>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                <span class="text-sm font-medium text-gray-700 mr-3">Titres :</span>
                                <button type="button" class="format-tool" data-prefix="** " data-suffix=" **">
                                    <i class="fas fa-heading"></i> Titre principal
                                </button>
                                <button type="button" class="format-tool" data-prefix="## " data-suffix=" ##">
                                    <i class="fas fa-heading text-sm"></i> Sous-titre
                                </button>
                                <button type="button" class="format-tool" data-prefix="### " data-suffix=" ###">
                                    <i class="fas fa-heading text-xs"></i> Section
                                </button>
                            </div>
                        </div>
                        
                        <!-- Zone de contenu -->
                        <div class="structured-content">
                            <textarea 
                                id="id_contenu" 
                                name="contenu" 
                                rows="25" 
                                class="w-full p-4 border border-gray-300 rounded-md font-mono text-sm leading-relaxed whitespace-pre"
                                placeholder="Écrivez votre contenu ici... Tous les sauts de ligne et espaces seront préservés à l'affichage.">{{ form.contenu.value|default:'' }}</textarea>
                        </div>
                        
                        {% if form.contenu.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.contenu.errors.0 }}</p>
                        {% endif %}
                        
                        <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="text-sm text-gray-600 p-3 bg-gray-50 rounded">
                                <p class="font-medium mb-2 text-gray-800">Exemple de formatage :</p>
                                <div class="font-mono text-xs space-y-1">
                                    <div>**TITRE PRINCIPAL**</div>
                                    <div>## Sous-titre ##</div>
                                    <div>1. Premier point</div>
                                    <div>   • Sous-point</div>
                                    <div>Nom : _______________</div>
                                    <div>───────────────</div>
                                </div>
                            </div>
                            
                            <div class="text-sm text-gray-600 p-3 bg-blue-50 rounded">
                                <p class="font-medium mb-2 text-blue-800">Conseils pour les formulaires :</p>
                                <ul class="list-disc pl-5 space-y-1">
                                    <li>Utilisez des lignes (─────) pour séparer les sections</li>
                                    <li>Les tirets (_______) pour les champs à remplir</li>
                                    <li>Les sauts de ligne sont préservés</li>
                                    <li>Utilisez des espaces pour l'alignement</li>
                                    <li>Le texte s'affichera exactement comme ici</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Boutons d'exemples -->
                        <div class="mt-4 flex flex-wrap gap-2">
                            <button type="button" id="load-form-example" class="text-sm bg-blue-100 hover:bg-blue-200 text-blue-800 font-medium py-2 px-4 rounded-md transition duration-300">
                                <i class="fas fa-file-contract mr-2"></i>Exemple de formulaire
                            </button>
                            <button type="button" id="load-quiz-example" class="text-sm bg-green-100 hover:bg-green-200 text-green-800 font-medium py-2 px-4 rounded-md transition duration-300">
                                <i class="fas fa-question-circle mr-2"></i>Exemple de quiz
                            </button>
                            <button type="button" id="load-lesson-example" class="text-sm bg-purple-100 hover:bg-purple-200 text-purple-800 font-medium py-2 px-4 rounded-md transition duration-300">
                                <i class="fas fa-book-open mr-2"></i>Exemple de cours
                            </button>
                        </div>
                        
                        <!-- Bouton de prévisualisation -->
                        <div class="mt-4">
                            <button type="button" id="preview-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md transition duration-300 text-sm">
                                <i class="fas fa-eye mr-2"></i>Prévisualiser le contenu
                            </button>
                        </div>
                        
                        <!-- Zone de prévisualisation -->
                        <div id="preview-content" class="hidden mt-4 border border-gray-200 rounded-md overflow-hidden">
                            <div class="bg-gray-800 text-white p-3 flex justify-between items-center">
                                <h3 class="font-bold text-lg">Prévisualisation :</h3>
                                <button type="button" id="close-preview" class="text-gray-300 hover:text-white">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div id="preview-text" class="preview-formatted bg-white p-6 min-h-[300px] font-mono whitespace-pre-wrap leading-relaxed"></div>
                        </div>
                    </div>

                    <!-- Fichier -->
                    <div>
                        <label for="{{ form.fichier.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Document du cours (optionnel)
                        </label>
                        {{ form.fichier }}
                        {% if form.fichier.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.fichier.errors.0 }}</p>
                        {% endif %}
                        <small class="text-gray-500">{{ form.fichier.help_text }}</small>

                        <!-- Affichage du fichier existant -->
                        {% if form.instance.pk and form.instance.fichier %}
                        <div class="mt-3 p-3 bg-green-50 border border-green-200 rounded-md">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fas fa-file text-green-600 mr-2"></i>
                                    <span class="text-sm text-green-800">
                                        Fichier actuel : 
                                        <a href="{{ form.instance.fichier.url }}" target="_blank" class="font-medium underline">
                                            {{ form.instance.fichier.name|slice:"15:" }}
                                        </a>
                                        ({{ form.instance.fichier.size|filesizeformat }})
                                    </span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <a href="{{ form.instance.fichier.url }}" target="_blank" 
                                       class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                        <i class="fas fa-eye mr-1"></i>Voir
                                    </a>
                                    <a href="{{ form.instance.fichier.url }}" download 
                                       class="text-green-600 hover:text-green-800 text-sm font-medium">
                                        <i class="fas fa-download mr-1"></i>Télécharger
                                    </a>
                                </div>
                            </div>
                            <label class="flex items-center mt-2 text-sm text-gray-600">
                                <input type="checkbox" name="fichier-clear" id="fichier-clear-id" class="mr-2">
                                Supprimer le fichier actuel
                            </label>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-8 pt-6 border-t border-gray-200">
                    <a href="{% url 'cours:list' %}" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-6 rounded-md transition duration-300">
                        Annuler
                    </a>
                    <button type="submit" class="bg-[#0EA7A7] hover:bg-teal-600 text-white font-medium py-2 px-6 rounded-md transition duration-300">
                        {% if form.instance.pk %}Modifier{% else %}Créer le cours{% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* Style pour la zone de texte avec préservation du format */
#id_contenu {
    font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
    line-height: 1.6;
    background-color: #f9fafb;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    resize: vertical;
    white-space: pre;
    tab-size: 4;
}

#id_contenu:focus {
    background-color: white;
    border-color: #0EA7A7;
    box-shadow: 0 0 0 3px rgba(14, 167, 167, 0.1);
}

/* Barre d'outils */
.format-tool {
    padding: 0.375rem 0.75rem;
    background-color: white;
    border: 1px solid #d1d5db;
    border-radius: 0.25rem;
    font-size: 0.875rem;
    color: #4b5563;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.375rem;
}

.format-tool:hover {
    background-color: #f3f4f6;
    border-color: #0EA7A7;
    color: #0EA7A7;
}

/* Style pour la prévisualisation */
.preview-formatted {
    font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
    font-size: 14px;
    line-height: 1.8;
    color: #1f2937;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/* Styles spéciaux pour le formatage */
.preview-formatted strong {
    display: block;
    text-align: center;
    font-size: 1.5em;
    margin: 1em 0;
    color: #1e40af;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.preview-formatted em {
    color: #0EA7A7;
    font-style: normal;
    font-weight: 600;
}

/* Styles pour les éléments de formulaire */
.field-line {
    margin: 0.5em 0;
}

.field-label {
    display: inline-block;
    width: 200px;
    font-weight: 500;
}

.field-input {
    display: inline-block;
    border-bottom: 1px solid #4b5563;
    min-width: 200px;
    height: 1.2em;
}

/* Style pour les séparateurs */
.separator {
    border-top: 2px dashed #9ca3af;
    margin: 1.5em 0;
}

/* Style pour les listes */
.preview-formatted ul {
    margin-left: 2em;
    list-style-type: none;
}

.preview-formatted li {
    margin: 0.25em 0;
    position: relative;
}

.preview-formatted li:before {
    content: "•";
    color: #0EA7A7;
    font-weight: bold;
    display: inline-block;
    width: 1em;
    margin-left: -1em;
}

/* Style pour les cases à cocher */
.checkbox {
    display: inline-block;
    width: 1em;
    height: 1em;
    border: 1px solid #4b5563;
    margin-right: 0.5em;
    vertical-align: middle;
}

/* Animation */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

#preview-content {
    animation: fadeIn 0.3s ease-out;
}

/* Aide visuelle pour l'alignement */
.alignment-guide {
    position: absolute;
    right: 1rem;
    top: 1rem;
    color: #9ca3af;
    font-size: 0.75rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const contenuTextarea = document.getElementById('id_contenu');
    const previewBtn = document.getElementById('preview-btn');
    const previewText = document.getElementById('preview-text');
    const previewContent = document.getElementById('preview-content');
    const closePreview = document.getElementById('close-preview');
    
    // Exemple de formulaire (votre document)
    const formExample = `FORMULAIRE D'INSCRIPTION – PARTICULIER (OFFRE GRATUITE)
Hub des Références
${'='.repeat(60)}

**1. Identité du particulier**
${'-'.repeat(40)}
Nom : _______________
Prénom : _______________
Ville / Commune : _______________
Quartier : _______________
Téléphone : _______________
Email (optionnel) : _______________

**2. Type d'offres proposées**
${'-'.repeat(40)}
Compétence professionnelle (1 maximum) : _______________
Service du quotidien (1 maximum) : _______________

**3. Description courte**
${'-'.repeat(40)}
Description de la compétence (300 caractères) : 
${'_'.repeat(60)}

Description du service (300 caractères) : 
${'_'.repeat(60)}

**4. Disponibilité**
${'-'.repeat(40)}
Jours disponibles : _______________
Plages horaires : _______________

**5. Zone d'intervention**
${'-'.repeat(40)}
Zone principale : _______________
Déplacements possibles (Oui / Non) : _______________

**6. Statut de recherche**
${'-'.repeat(40)}
☐ Recherche emploi
☐ Recherche stage  
☐ Recherche mission
☐ Ouvert(e) aux opportunités

**7. Engagement**
${'-'.repeat(40)}
☐ Acceptation des conditions et de la règle de segmentation

${'='.repeat(60)}
Date : __/__/____
Signature : _______________`;
    
    // Exemple de quiz
    const quizExample = `**QUIZ : Mathématiques - Niveau Terminale**
${'='.repeat(60)}

**Question 1**
${'-'.repeat(40)}
Quelle est la dérivée de f(x) = 3x² + 2x - 5 ?

a) 6x + 2
b) 3x + 2  
c) 6x² + 2
d) 3x² + 2

Réponse : _____

**Question 2**
${'-'.repeat(40)}
Résoudre l'équation : 2x + 5 = 13

a) x = 4
b) x = 6
c) x = 8
d) x = 9

Réponse : _____

**Question 3**
${'-'.repeat(40)}
Calculer l'intégrale : ∫(2x dx) de 0 à 3

a) 6
b) 9
c) 12
d) 18

Réponse : _____
`;
    
    // Exemple de cours structuré
    const lessonExample = `**Introduction à la Programmation Python**
${'='.repeat(60)}

**Objectifs du cours**
${'-'.repeat(40)}
• Comprendre les bases de la programmation
• Maîtriser la syntaxe Python
• Savoir créer des programmes simples
• Préparer aux concepts avancés

**1. Les variables**
${'-'.repeat(40)}
Définition : Une variable est un espace mémoire nommé.

Exemple :
  nom = "Jean"
  age = 25
  temperature = 22.5

**2. Les structures de contrôle**
${'-'.repeat(40)}
2.1 Condition if
  if age >= 18:
      print("Majeur")
  else:
      print("Mineur")

2.2 Boucle for
  for i in range(5):
      print(i)

**Exercices**
${'-'.repeat(40)}
1. Écrire un programme qui demande un nombre et affiche son carré.
2. Créer une fonction qui calcule la moyenne de trois nombres.
`;
    
    // Charger les exemples
    document.getElementById('load-form-example').addEventListener('click', function() {
        contenuTextarea.value = formExample;
        showNotification('Exemple de formulaire chargé');
    });
    
    document.getElementById('load-quiz-example').addEventListener('click', function() {
        contenuTextarea.value = quizExample;
        showNotification('Exemple de quiz chargé');
    });
    
    document.getElementById('load-lesson-example').addEventListener('click', function() {
        contenuTextarea.value = lessonExample;
        showNotification('Exemple de cours chargé');
    });
    
    // Outils de formatage
    document.querySelectorAll('.format-tool').forEach(tool => {
        tool.addEventListener('click', function() {
            const textarea = contenuTextarea;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            let insertText = this.dataset.insert;
            const prefix = this.dataset.prefix;
            const suffix = this.dataset.suffix;
            
            if (prefix && suffix) {
                if (selectedText) {
                    insertText = prefix + selectedText + suffix;
                } else {
                    insertText = prefix + 'Texte' + suffix;
                }
            }
            
            // Insérer le texte
            textarea.value = textarea.value.substring(0, start) + insertText + textarea.value.substring(end);
            
            // Remettre le focus et ajuster le curseur
            textarea.focus();
            const newPos = start + insertText.length;
            textarea.selectionStart = textarea.selectionEnd = newPos;
            
            // Déclencher l'événement input
            textarea.dispatchEvent(new Event('input'));
        });
    });
    
    // Prévisualisation avec formatage amélioré
    previewBtn.addEventListener('click', function() {
        let contenu = contenuTextarea.value;
        
        if (!contenu.trim()) {
            previewText.innerHTML = '<p class="text-gray-500 italic">Aucun contenu à prévisualiser.</p>';
            previewContent.classList.remove('hidden');
            return;
        }
        
        // Appliquer un formatage basique
        let formatted = contenu;
        
        // Convertir les **texte** en titres
        formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<div class="text-center font-bold text-xl text-blue-800 my-4 pb-2 border-b-2 border-blue-200">$1</div>');
        
        // Convertir les ## texte ## en sous-titres
        formatted = formatted.replace(/##(.*?)##/g, '<div class="font-bold text-lg text-gray-800 mt-3 mb-2">$1</div>');
        
        // Convertir les ### texte ### en sections
        formatted = formatted.replace(/###(.*?)###/g, '<div class="font-semibold text-gray-700 mt-2 mb-1">$1</div>');
        
        // Convertir les lignes de séparation
        formatted = formatted.replace(/═{10,}/g, '<div class="border-t-2 border-gray-800 my-4"></div>');
        formatted = formatted.replace(/─{10,}/g, '<div class="border-t border-dashed border-gray-400 my-3"></div>');
        formatted = formatted.replace(/_+ {5,}/g, '<span class="inline-block border-b border-gray-800 min-w-[200px]">&nbsp;</span>');
        
        // Convertir les listes
        formatted = formatted.replace(/^\d+\.\s+(.*)$/gm, '<div class="ml-4">$1</div>');
        formatted = formatted.replace(/^•\s+(.*)$/gm, '<div class="ml-6">• $1</div>');
        
        // Convertir les cases à cocher
        formatted = formatted.replace(/☐/g, '<span class="inline-block w-4 h-4 border border-gray-600 mr-2 align-middle"></span>');
        
        // Préserver les sauts de ligne
        formatted = formatted.replace(/\n/g, '<br>');
        
        previewText.innerHTML = formatted;
        previewContent.classList.remove('hidden');
        
        // Défiler vers la prévisualisation
        previewContent.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    });
    
    // Fermer la prévisualisation
    if (closePreview) {
        closePreview.addEventListener('click', function() {
            previewContent.classList.add('hidden');
        });
    }
    
    // Validation
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const titre = document.querySelector('#id_titre').value.trim();
        const matiere = document.querySelector('#id_matiere').value;
        const contenu = contenuTextarea.value.trim();

        if (!titre || !matiere || !contenu) {
            e.preventDefault();
            alert('Veuillez remplir tous les champs obligatoires (*)');
            return false;
        }
        
        if (contenu.length < 50) {
            e.preventDefault();
            alert('Le contenu doit contenir au moins 50 caractères.');
            return false;
        }
        
        // Validation fichier
        const fileInput = document.querySelector('#id_fichier');
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const maxSize = 10 * 1024 * 1024;
            
            if (file.size > maxSize) {
                e.preventDefault();
                alert('Le fichier est trop volumineux (max 10MB).');
                return false;
            }
        }
    });
    
    // Notification
    function showNotification(message) {
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-fadeIn';
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.add('opacity-0', 'transition-opacity', 'duration-300');
            setTimeout(() => notification.remove(), 300);
        }, 2000);
    }
    
    // Gestion de la tabulation
    contenuTextarea.addEventListener('keydown', function(e) {
        if (e.key === 'Tab') {
            e.preventDefault();
            const start = this.selectionStart;
            const end = this.selectionEnd;
            
            this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
            this.selectionStart = this.selectionEnd = start + 4;
        }
    });
    
    // Compteur de caractères
    const charCount = document.createElement('div');
    charCount.className = 'text-xs text-gray-500 mt-2 text-right';
    contenuTextarea.parentNode.appendChild(charCount);
    
    function updateCharCount() {
        const length = contenuTextarea.value.length;
        charCount.textContent = `${length} caractères`;
        
        if (length > 5000) {
            charCount.classList.add('text-red-600');
            charCount.classList.remove('text-gray-500');
        } else if (length > 3000) {
            charCount.classList.add('text-yellow-600');
            charCount.classList.remove('text-gray-500');
        } else {
            charCount.classList.remove('text-red-600', 'text-yellow-600');
            charCount.classList.add('text-gray-500');
        }
    }
    
    contenuTextarea.addEventListener('input', updateCharCount);
    updateCharCount();
});
</script>
{% endblock %}