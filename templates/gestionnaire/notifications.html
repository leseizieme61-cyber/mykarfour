{% extends 'base.html' %}
{% load static %}

{% block title %}Mes Notifications - MyKarfour{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- En-tête de la page -->
        <div class="mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Mes Notifications</h1>
                    <p class="text-gray-600 mt-2">Restez informé de vos activités et mises à jour</p>
                </div>
                <div class="flex flex-wrap gap-3">
                    {% if notifications %}
                    <form method="post" action="{% url 'marquer_toutes_notifications_lues' %}" id="form-tout-marquer-lu">
                        {% csrf_token %}
                        <button type="submit" 
                                class="px-4 py-2 bg-[#0EA7A7] text-white rounded-lg hover:bg-[#0d9696] transition-all duration-200 flex items-center gap-2 shadow-sm">
                            <i class="fas fa-check-double"></i>
                            <span>Tout marquer comme lu</span>
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Cartes de statistiques -->
        {% if notifications %}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200 text-center">
                <div class="text-2xl font-bold text-[#0EA7A7] mb-2">{{ notifications.count }}</div>
                <div class="text-gray-600 text-sm font-medium">Total</div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200 text-center">
                <div class="text-2xl font-bold text-[#0EA7A7] mb-2">
                    {{ notifications_non_lues }}
                </div>
                <div class="text-gray-600 text-sm font-medium">Non lues</div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200 text-center">
                <div class="text-2xl font-bold text-[#0EA7A7] mb-2">{{ notifications_lues }}</div>
                <div class="text-gray-600 text-sm font-medium">Déjà lues</div>
            </div>
        </div>
        {% endif %}

        <!-- Liste des notifications -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            {% if notifications %}
                <div class="divide-y divide-gray-100">
                    {% for notification in notifications %}
                    <div class="p-6 hover:bg-gray-50 transition-all duration-200 {% if not notification.lue %}bg-blue-50 border-l-4 border-[#0EA7A7]{% endif %}">
                        <div class="flex items-start justify-between gap-4">
                            <div class="flex-1 min-w-0">
                                <!-- En-tête de la notification -->
                                <div class="flex items-center gap-3 mb-3">
                                    {% if not notification.lue %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-[#0EA7A7] text-white">
                                        Nouveau
                                    </span>
                                    {% endif %}
                                    <span class="text-sm text-gray-500 flex items-center gap-1">
                                        <i class="far fa-clock w-4 h-4"></i>
                                        {{ notification.date_creation|timesince }}
                                    </span>
                                </div>

                                <!-- Contenu de la notification -->
                                <h3 class="text-lg font-semibold text-gray-900 mb-2">
                                    {{ notification.titre }}
                                </h3>
                                
                                <p class="text-gray-700 leading-relaxed mb-4">
                                    {{ notification.contenu }}
                                </p>

                                <!-- Date complète -->
                                <div class="text-sm text-gray-500">
                                    <i class="far fa-calendar mr-1"></i>
                                    {{ notification.date_creation|date:"d/m/Y à H:i" }}
                                </div>
                            </div>
                            
                            <!-- Actions -->
                            <div class="flex items-center gap-2 flex-shrink-0">
                                {% if not notification.lue %}
                                <form method="post" action="{% url 'marquer_notification_lue' notification.id %}" class="marquer-lue-form">
                                    {% csrf_token %}
                                    <button type="submit" 
                                            class="w-10 h-10 flex items-center justify-center bg-green-100 text-green-600 rounded-lg hover:bg-green-200 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2"
                                            title="Marquer comme lue">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </form>
                                {% else %}
                                <span class="w-10 h-10 flex items-center justify-center bg-gray-100 text-gray-400 rounded-lg" title="Déjà lue">
                                    <i class="fas fa-check"></i>
                                </span>
                                {% endif %}
                                
                                <form method="post" action="{% url 'supprimer_notification' notification.id %}" class="supprimer-form">
                                    {% csrf_token %}
                                    <button type="submit" 
                                            class="w-10 h-10 flex items-center justify-center bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2"
                                            title="Supprimer">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <!-- État vide -->
                <div class="text-center py-16">
                    <div class="w-24 h-24 mx-auto mb-6 bg-gray-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-bell-slash text-3xl text-gray-400"></i>
                    </div>
                    <h3 class="text-2xl font-semibold text-gray-900 mb-3">Aucune notification</h3>
                    <p class="text-gray-600 max-w-md mx-auto mb-8">
                        Vous n'avez aucune notification pour le moment. Vos nouvelles activités apparaîtront ici.
                    </p>
                    <a href="{% url 'tableau_de_bord' %}" 
                       class="inline-flex items-center px-6 py-3 bg-[#0EA7A7] text-white rounded-lg hover:bg-[#0d9696] transition-all duration-200 shadow-sm">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Retour au tableau de bord
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Marquer comme lue avec AJAX
    document.querySelectorAll('.marquer-lue-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const formElement = this;
            const submitButton = formElement.querySelector('button');
            
            // Désactiver le bouton pendant la requête
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            fetch(formElement.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': formElement.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: new FormData(formElement)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const notificationItem = formElement.closest('.hover\\:bg-gray-50');
                    
                    // Retirer le style de notification non lue
                    notificationItem.classList.remove('bg-blue-50', 'border-l-4', 'border-[#0EA7A7]');
                    
                    // Retirer le badge "Nouveau"
                    const nouveauBadge = notificationItem.querySelector('.bg-\\[\\#0EA7A7\\]');
                    if (nouveauBadge) {
                        nouveauBadge.remove();
                    }
                    
                    // Remplacer le bouton par un indicateur "déjà lu"
                    const buttonContainer = formElement.parentElement;
                    buttonContainer.innerHTML = `
                        <span class="w-10 h-10 flex items-center justify-center bg-gray-100 text-gray-400 rounded-lg" title="Déjà lue">
                            <i class="fas fa-check"></i>
                        </span>
                    `;
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Une erreur est survenue. Veuillez réessayer.');
            })
            .finally(() => {
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-check"></i>';
            });
        });
    });

    // Supprimer notification avec AJAX
    document.querySelectorAll('.supprimer-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const formElement = this;
            
            if (!confirm('Êtes-vous sûr de vouloir supprimer cette notification ?')) {
                return;
            }
            
            const submitButton = formElement.querySelector('button');
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            fetch(formElement.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': formElement.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: new FormData(formElement)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const notificationItem = formElement.closest('.hover\\:bg-gray-50');
                    
                    // Animation de suppression
                    notificationItem.style.transition = 'all 0.3s ease';
                    notificationItem.style.opacity = '0';
                    notificationItem.style.transform = 'translateX(-10px)';
                    
                    setTimeout(() => {
                        notificationItem.remove();
                        
                        // Si plus de notifications, recharger la page
                        if (document.querySelectorAll('.hover\\:bg-gray-50').length === 0) {
                            location.reload();
                        }
                    }, 300);
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Une erreur est survenue. Veuillez réessayer.');
            })
            .finally(() => {
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-times"></i>';
            });
        });
    });

    // Tout marquer comme lu (formulaire standard)
    document.getElementById('form-tout-marquer-lu')?.addEventListener('submit', function(e) {
        if (!confirm('Êtes-vous sûr de vouloir marquer toutes les notifications comme lues ?')) {
            e.preventDefault();
            return;
        }
        
        const button = this.querySelector('button');
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Traitement...';
        
        // Laisser le formulaire se soumettre normalement
        // Le rechargement de la page se fera automatiquement
    });
});
</script>

<style>
/* Styles personnalisés pour une meilleure expérience */
.bg-\[\#0EA7A7\] {
    background-color: #0EA7A7;
}

.border-\[\#0EA7A7\] {
    border-color: #0EA7A7;
}

.hover\:bg-\[\#0d9696\]:hover {
    background-color: #0d9696;
}

/* Animation pour les boutons */
button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Transition pour les cartes de notification */
.hover\:bg-gray-50 {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Style pour les icônes de chargement */
.fa-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}